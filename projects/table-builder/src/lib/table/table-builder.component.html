<div
    #root
    observerView
    [style.width]="width"
    class="table-grid__root"
    [style.height.px]="height"
    [class.table-grid__root--is-scroll-overload]="tableViewport.scrollWidth > tableViewport.clientWidth"
    [class.table-grid__root--empty-list]="!source?.length && !this.filterable.filtering && !this.isFrozenView"
    [class.table-grid__root-auto-height]="autoHeightDetect"
    [class.table-grid__root--content-is-init]="contentInit && inViewport"
    (contextmenu)="contextMenuTemplate ? contextMenu.openContextMenu($event) : null"
    [class.table-grid__root--visible]="contentInit && root.offsetHeight > clientRowHeight && columnHeight"
    (observeVisible)="checkVisible($event)"
    (recalculatedHeight)="detectChanges()"
    [autoHeight]="{
        detect: autoHeightDetect,
        height: height,
        inViewport: inViewport,
        columnHeight: columnHeight,
        statusRendered: isRendered,
        sourceLength: source?.length || 0
    }"
    [headerHeight]="headerRef?.nativeElement.clientHeight"
    [footerHeight]="footerRef?.nativeElement.clientHeight"
>
    <div
        cdkDropList
        #tableViewport
        wheelThrottling
        class="table-grid"
        (scrollEnd)="scrollEnd()"
        [cdkDropListDisabled]="!accessDragging"
        (scrollOffset)="updateScrollOffset($event)"
        (scrollOverload)="updateScrollOverload($event)"
        [class.table-grid__native-scrollbar]="nativeScrollbar"
        cdkDropListOrientation="horizontal"
        (cdkDropListDropped)="drop($event)"
    >
        <div class="table-grid__header-sticky" *ngIf="headerTemplate" #header>
            <ng-content select="ngx-header"></ng-content>
        </div>

        <div
            class="table-grid__column-area-content"
            [style.width.px]="
                tableViewportChecked && tableViewport.scrollWidth > tableViewport.clientWidth
                    ? tableViewport.scrollWidth
                    : null
            "
        >
            <div
                #column
                cdkDrag
                observerView
                [attr.column-id]="key"
                [rendered]="isRendered"
                [cdkDragStartDelay]="100"
                [cdkDragDisabled]="!accessDragging"
                class="table-grid__column"
                [style.height.px]="columnHeight"
                [ngStyle]="columns[key]?.cssStyle"
                [ngClass]="columns[key]?.cssClass"
                [style.width.px]="columns[key]?.width"
                cdkDragBoundary=".table-grid__column-area-content"
                *ngFor="let key of displayedColumns; let index = index"
                [style.min-width.px]="columns[key]?.width || clientColWidth"
                [class.table-grid__column--with-footer-content]="footerTemplate"
                [class.table-grid__column--vertical-line]="verticalBorder || columns[key]?.verticalLine"
                [class.table-grid__column--custom-column]="columns[key]?.customColumn"
                [class.table-grid__column--selected-all]="selection.selectionModel.isAll"
                [class.table-grid__column--sticky-left]="columns[key]?.stickyLeft"
                [class.table-grid__column--sticky-right]="columns[key]?.stickyRight"
                [class.table-grid__column--is-visible]="column['visible']"
                [class.table-grid__column--is-invisible]="!column['visible']"
                [class.table-grid__column--default-width]="!autoWidth"
                (observeVisible)="markVisibleColumn(column, $event)"
            >
                <div
                    class="table-grid__column-area"
                    *ngIf="asyncColumns === false || column['visible']"
                    [@fadeAnimation]
                >
                    <table-thead
                        [column-key]="key"
                        (mouseenter)="enableDragging()"
                        [header-top]="headerRef?.nativeElement.offsetHeight || 0"
                        [sortable-definition]="sortable.definition"
                        [filterable-definition]="filterable.definition"
                        [client-row-height]="clientRowHeight"
                        [class.table-head__offset]="scrollOffset.offset"
                        (resize)="resizeColumn($event, column)"
                        (sortByKey)="sortByKey($event)"
                    >
                        <div
                            cdkDragHandle
                            slot="draggable"
                            *ngIf="columns[key]?.draggable"
                            class="table-grid__column--draggable"
                        >
                            <img
                                class="table-grid-icon--draggable"
                                src='data:image/svg+xml;utf8,<svg height="32px" id="Layer_1" style="enable-background:new 0 0 32 32;" version="1.1" viewBox="0 0 32 32" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M31.338,14.538L27.38,10.58C26.994,10.193,26.531,10,26,10c-1.188,0-2,1.016-2,2c0,0.516,0.186,0.986,0.58,1.38L25.2,14H18  V6.8l0.62,0.62C19.014,7.814,19.484,8,20,8c0.984,0,2-0.813,2-2c0-0.531-0.193-0.994-0.58-1.38l-3.973-3.974  C17.08,0.279,16.729,0,16,0s-1.135,0.334-1.463,0.662L10.58,4.62C10.193,5.006,10,5.469,10,6c0,1.188,1.016,2,2,2  c0.516,0,0.986-0.186,1.38-0.58L14,6.8V14H6.8l0.62-0.62C7.814,12.986,8,12.516,8,12c0-0.984-0.813-2-2-2  c-0.531,0-0.994,0.193-1.38,0.58l-3.958,3.958C0.334,14.866,0,15.271,0,16s0.279,1.08,0.646,1.447L4.62,21.42  C5.006,21.807,5.469,22,6,22c1.188,0,2-1.016,2-2c0-0.516-0.186-0.986-0.58-1.38L6.8,18H14v7.2l-0.62-0.62  C12.986,24.186,12.516,24,12,24c-0.984,0-2,0.813-2,2c0,0.531,0.193,0.994,0.58,1.38l3.957,3.958C14.865,31.666,15.271,32,16,32  s1.08-0.279,1.447-0.646l3.973-3.974C21.807,26.994,22,26.531,22,26c0-1.188-1.016-2-2-2c-0.516,0-0.986,0.186-1.38,0.58L18,25.2V18  h7.2l-0.62,0.62C24.186,19.014,24,19.484,24,20c0,0.984,0.813,2,2,2c0.531,0,0.994-0.193,1.38-0.58l3.974-3.973  C31.721,17.08,32,16.729,32,16S31.666,14.866,31.338,14.538z"/></svg>'
                                alt="sort"
                            />
                        </div>
                    </table-thead>

                    <table-tbody
                        [source]="source"
                        [column-key]="key"
                        [striped]="striped"
                        [column-index]="index"
                        [is-rendered]="isRendered"
                        [primary-key]="primaryKey"
                        [throttling]="throttling"
                        (mouseenter)="disableDragging()"
                        [buffer-amount]="bufferAmount"
                        [table-viewport]="tableViewport"
                        [scroll-overload]="scrollOverload"
                        [context-menu]="contextMenuTemplate"
                        [enable-selection]="enableSelection"
                        [client-row-height]="clientRowHeight"
                        [selection-entries]="selectionEntries"
                        [showed-cell-by-default]="showedCellByDefault"
                        [column-virtual-height]="columnVirtualHeight"
                    >
                    </table-tbody>
                </div>
            </div>
        </div>

        <div class="table-grid__footer-sticky" *ngIf="footerTemplate && isRendered" #footer [@fadeAnimation]>
            <ng-content select="ngx-footer"></ng-content>
        </div>
    </div>

    <div *ngIf="isFrozenView" class="freeze"></div>
</div>

<ng-template [ngIf]="contextMenuTemplate && contextMenu.state.opened">
    <ng-content select="ngx-context-menu"></ng-content>
</ng-template>

<div *ngIf="!source?.length">
    <ng-content select="ngx-empty"></ng-content>
</div>

<ng-template [ngIf]="filterTemplate">
    <ng-content select="ngx-filter"></ng-content>
</ng-template>
