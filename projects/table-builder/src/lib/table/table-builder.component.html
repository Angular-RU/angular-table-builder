<div
    #root
    observerView
    [style.width]="width"
    class="table-grid__root"
    [style.height.px]="height"
    [class.table-grid__root--is-rendered]="isRendered"
    [class.table-grid__root--is-scrolling]="isScrolling"
    [class.table-grid__root-auto-height]="autoHeightDetect"
    [class.table-grid__no-display]="!(columnSchema.length > 0)"
    [class.table-grid__root--content-is-init]="contentInit && inViewport"
    [class.table-grid__root--is-scroll-overload]="tableViewport.scrollWidth > tableViewport.clientWidth"
    [class.table-grid__root--empty-list]="!source?.length && !filterable.filtering && !isFrozenView"
    [class.table-grid__root--visible]="contentInit && root.offsetHeight > clientRowHeight && columnHeight"
    (contextmenu)="contextMenuTemplate ? contextMenu.openContextMenu($event) : null"
    (recalculatedHeight)="recalculateHeight()"
    (observeVisible)="checkVisible($event)"
    [autoHeight]="{
        detect: autoHeightDetect,
        height: height,
        inViewport: inViewport,
        columnHeight: columnHeight,
        statusRendered: isRendered,
        sourceLength: source?.length || 0
    }"
    [tableViewport]="tableViewport"
    [headerHeight]="headerRef?.nativeElement.clientHeight"
    [footerHeight]="footerRef?.nativeElement.clientHeight"
>
    <div class="table-grid__header-sticky" *ngIf="headerTemplate" #header>
        <ng-content select="ngx-header"></ng-content>
    </div>

    <div
        cdkDropList
        #tableViewport
        class="table-grid"
        [wheelThrottling]="tableViewport"
        [cdkDropListDisabled]="!accessDragging"
        (scrollOffset)="updateScrollOffset($event)"
        [class.table-grid__scroll-offset]="scrollOffset.offset"
        [class.table-grid__native-scrollbar]="nativeScrollbar"
        cdkDropListOrientation="horizontal"
        (cdkDropListDropped)="drop($event)"
    >
        <div
            [@fadeAnimation]
            *ngIf="isRendered"
            [style.height.px]="root.offsetHeight"
            class="table-grid__column-area-content"
            [style.width.px]="
                tableViewportChecked && tableViewport.scrollWidth > tableViewport.clientWidth
                    ? tableViewport.scrollWidth
                    : null
            "
        >
            <ngx-loading *ngIf="!filterable.filtering"></ngx-loading>
            <div class="virtual-scroll-viewport">
                <cdk-virtual-scroll-viewport
                    autosize
                    #virtualScroll
                    [itemSize]="clientRowHeight"
                    [style.height.px]="root.offsetHeight"
                    [minBufferPx]="autosize ? root.offsetHeight * 2 : 400"
                    [maxBufferPx]="autosize ? root.offsetHeight * 2 : 400"
                >
                    <ngx-table-head
                        [schema]="columnSchema"
                        [head-height]="headHeight"
                        [cell-height]="clientRowHeight"
                        [cell-width]="clientColWidth"
                        [style.top]="inverseTranslation"
                        class="table-grid__row table-grid__row--head"
                    ></ngx-table-head>

                    <ng-container
                        *cdkVirtualFor="let item of source; let index = index; let even = even; templateCacheSize: 0; trackBy: trackByRow.bind(this)"
                    >
                        <ngx-table-row
                            [item]="item"
                            [even]="even"
                            [index]="index"
                            [striped]="striped"
                            [source]="source"
                            class="table-grid__row"
                            [primary-key]="primaryKey"
                            [columnSchema]="columnSchema"
                            [cell-width]="clientColWidth"
                            [cell-height]="clientRowHeight"
                            [context-menu]="contextMenuTemplate"
                            [enable-filtering]="enableFiltering"
                            [enable-selection]="enableSelection"
                            [selection-entries]="selectionEntries"
                            [style.min-height.px]="autosize ? null : clientRowHeight"
                            [style.max-height.px]="autosize ? null : clientRowHeight"
                        ></ngx-table-row>
                    </ng-container>
                </cdk-virtual-scroll-viewport>
            </div>
        </div>
    </div>

    <div class="table-grid__footer-sticky" *ngIf="footerTemplate && isRendered" #footer [@fadeAnimation]>
        <ng-content select="ngx-footer"></ng-content>
    </div>

    <div *ngIf="isFrozenView" class="freeze"></div>
</div>

<ng-template [ngIf]="contextMenuTemplate && contextMenu.state.opened">
    <ng-content select="ngx-context-menu"></ng-content>
</ng-template>

<div *ngIf="(source && source.length) === 0 && !filterable.filtering">
    <ng-content select="ngx-empty"></ng-content>
</div>

<div *ngIf="sourceIsNull">
    <ng-content select="ngx-source-null"></ng-content>
</div>

<ng-template [ngIf]="filterTemplate">
    <ng-content select="ngx-filter"></ng-content>
</ng-template>
